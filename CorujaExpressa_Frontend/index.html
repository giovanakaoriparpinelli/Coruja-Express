<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coruja Express - Autoatendimento</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- React e Babel (para rodar JSX no navegador) -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Estilos personalizados -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            color: #333;
        }
        .main-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .welcome-screen {
            text-align: center;
            animation: fadeIn 1s;
        }
        .logo {
            font-size: 3rem;
            font-weight: 700;
            color: #4a148c; /* Roxo escuro */
        }
        .logo .highlight {
            color: #ffab00; /* Amarelo vibrante */
        }
        .product-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.1);
        }
        .product-img {
            height: 150px;
            object-fit: cover;
        }
        .cart {
            background-color: #ffffff;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            position: sticky;
            top: 20px;
        }
        .btn-primary {
            background-color: #4a148c;
            border-color: #4a148c;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
        }
        .btn-primary:hover {
            background-color: #5e1a9e;
            border-color: #5e1a9e;
        }
        .btn-secondary {
            background-color: #ffab00;
            border-color: #ffab00;
            color: #333;
            font-weight: 600;
        }
         .btn-secondary:hover {
            background-color: #ffd600;
            border-color: #ffd600;
        }
        .qr-code-container {
            padding: 2rem;
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: center;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // IMPORTANTE: Altere para a URL da sua API .NET em execução
        const API_URL = "http://localhost:5050/api";

        // --- Componentes (ShoppingCart, ProductCard) ---
        const ShoppingCart = ({ cart, onUpdateCart, onCheckout }) => {
            const calculateTotal = () => {
                return cart.reduce((total, item) => total + item.price * item.quantity, 0).toFixed(2);
            };

            return (
                <div className="cart">
                    <h3 className="mb-4 fw-bold">Seu Carrinho 🛒</h3>
                    {cart.length === 0 ? (
                        <p className="text-muted">Seu carrinho está vazio.</p>
                    ) : (
                        <ul className="list-group list-group-flush">
                            {cart.map(item => (
                                <li key={item.id} className="list-group-item d-flex justify-content-between align-items-center px-0">
                                    <div>
                                        <h6 className="my-0">{item.name}</h6>
                                        <small className="text-muted">R$ {item.price.toFixed(2)}</small>
                                    </div>
                                    <div className="d-flex align-items-center">
                                        <button className="btn btn-sm btn-outline-secondary" onClick={() => onUpdateCart(item, item.quantity - 1)}>-</button>
                                        <span className="mx-2">{item.quantity}</span>
                                        <button className="btn btn-sm btn-outline-secondary" onClick={() => onUpdateCart(item, item.quantity + 1)}>+</button>
                                    </div>
                                </li>
                            ))}
                        </ul>
                    )}
                    {cart.length > 0 && (
                        <>
                            <hr />
                            <div className="d-flex justify-content-between align-items-center">
                                <h5 className="fw-bold">Total:</h5>
                                <h5 className="fw-bold">R$ {calculateTotal()}</h5>
                            </div>
                            <div className="d-grid mt-4">
                                <button className="btn btn-primary btn-lg" onClick={onCheckout}>
                                    Finalizar Compra
                                </button>
                            </div>
                        </>
                    )}
                </div>
            );
        };

        const ProductCard = ({ product, onAddToCart }) => (
            <div className="col-md-6 col-lg-4 mb-4">
                <div className="card h-100 product-card" onClick={() => onAddToCart(product)}>
                    <img src={product.image || 'https://placehold.co/300x200/cccccc/ffffff?text=Produto'} className="card-img-top product-img" alt={product.name} />
                    <div className="card-body text-center">
                        <h5 className="card-title">{product.name}</h5>
                        <p className="card-text fs-5 fw-bold text-success">R$ {product.price.toFixed(2)}</p>
                    </div>
                    <div className="card-footer bg-transparent border-0 p-3">
                         <div className="d-grid">
                            <button className="btn btn-secondary">Adicionar</button>
                         </div>
                    </div>
                </div>
            </div>
        );

        // --- Telas (WelcomeScreen, ShopScreen, etc.) ---
        const WelcomeScreen = ({ onStart }) => (
            <div className="container">
                <div className="welcome-screen">
                    <h1 className="logo">Coruja<span className="highlight">Express</span>🦉</h1>
                    <p className="lead my-4">Sua pausa estratégica. Rápido, fácil e sem filas.</p>
                    <button className="btn btn-primary btn-lg" onClick={onStart}>
                        Iniciar Compra
                    </button>
                </div>
            </div>
        );

        const ShopScreen = ({ products, onAddToCart, cart, onUpdateCart, onCheckout }) => {
            const [searchTerm, setSearchTerm] = useState('');
            
            const filteredProducts = products.filter(p => 
                p.name.toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="container-fluid p-4">
                    <h2 className="logo text-center mb-4">Coruja<span className="highlight">Express</span>🦉</h2>
                    <div className="row">
                        <div className="col-lg-8">
                            <div className="mb-4">
                                <input 
                                    type="text" 
                                    className="form-control form-control-lg" 
                                    placeholder="🔎 O que você procura hoje?"
                                    value={searchTerm}
                                    onChange={(e) => setSearchTerm(e.target.value)}
                                />
                            </div>
                            <div className="row">
                                {filteredProducts.length > 0 ? (
                                    filteredProducts.map(product => (
                                        <ProductCard key={product.id} product={product} onAddToCart={onAddToCart} />
                                    ))
                                ) : (
                                    <p>Carregando produtos...</p>
                                )}
                            </div>
                        </div>
                        <div className="col-lg-4">
                            <ShoppingCart cart={cart} onUpdateCart={onUpdateCart} onCheckout={onCheckout} />
                        </div>
                    </div>
                </div>
            );
        };

        const PaymentScreen = ({ cart, onPaymentSuccess }) => {
            const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            
            const generatePixPayload = (pixKey, merchantName, city, amount) => {
                const formatValue = (fieldId, value) => {
                    const length = value.length.toString().padStart(2, '0');
                    return `${fieldId}${length}${value}`;
                };

                const payload = [
                    formatValue('00', '01'),
                    formatValue('26', formatValue('00', 'br.gov.bcb.pix') + formatValue('01', pixKey)),
                    formatValue('52', '0000'),
                    formatValue('53', '986'),
                    formatValue('54', amount.toFixed(2)),
                    formatValue('58', 'BR'),
                    formatValue('59', merchantName),
                    formatValue('60', city),
                    '6304'
                ];
                
                const payloadString = payload.join('');
                const crc16 = 'ABCD'; // Exemplo
                return payloadString + crc16;
            };
            
            const pixKey = "viniciusctiburcio@gmail.com";
            const merchantName = "Coruja Express";
            const city = "Cornelio P.";
            const pixPayload = generatePixPayload(pixKey, merchantName, city, total);
            
            const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(pixPayload)}`;

            return (
                <div className="container">
                    <div className="row justify-content-center">
                        <div className="col-md-8 col-lg-6">
                            <div className="qr-code-container">
                                <h2 className="fw-bold mb-3">Pagamento via PIX</h2>
                                <p className="lead">Total a pagar: <span className="fw-bold text-success">R$ {total.toFixed(2)}</span></p>
                                <img src={qrCodeUrl} alt="PIX QR Code" className="img-fluid my-3" />
                                <p className="fw-bold">Chave: {pixKey}</p>
                                <div className="alert alert-info">
                                    <strong>Instruções:</strong>
                                    <ol className="text-start mt-2">
                                        <li>Abra o app do seu banco e acesse a área PIX.</li>
                                        <li>Escolha "Pagar com QR Code" e aponte a câmera.</li>
                                        <li>Confirme o valor e finalize o pagamento.</li>
                                    </ol>
                                </div>
                                <div className="d-grid">
                                    <button className="btn btn-primary btn-lg" onClick={onPaymentSuccess}>
                                        JÁ PAGUEI!
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const ThankYouScreen = ({ onNewPurchase }) => {
            useEffect(() => {
                const timer = setTimeout(onNewPurchase, 5000);
                return () => clearTimeout(timer);
            }, []);

            return (
                <div className="container">
                    <div className="welcome-screen">
                        <h1 className="logo text-success">Obrigado!</h1>
                        <p className="lead my-4">Sua compra foi registrada. Volte sempre! 😊</p>
                        <div className="spinner-border text-primary" role="status">
                            <span className="visually-hidden">Loading...</span>
                        </div>
                        <p className="mt-3 text-muted">Voltando ao início...</p>
                    </div>
                </div>
            );
        };


        // --- Componente Principal da Aplicação ---
        const App = () => {
            const [view, setView] = useState('welcome');
            const [cart, setCart] = useState([]);
            const [products, setProducts] = useState([]);
            const [error, setError] = useState(null);

            useEffect(() => {
                if (view === 'shop') { // Busca produtos apenas quando entra na tela da loja
                    const fetchProducts = async () => {
                        try {
                            const response = await fetch(`${API_URL}/products`);
                            if (!response.ok) {
                                throw new Error('Não foi possível carregar os produtos. O sistema do backend está no ar?');
                            }
                            const data = await response.json();
                            setProducts(data);
                        } catch (err) {
                            setError(err.message);
                        }
                    };
                    fetchProducts();
                }
            }, [view]);

            const handleAddToCart = (product) => {
                setCart(currentCart => {
                    const existingItem = currentCart.find(item => item.id === product.id);
                    if (existingItem) {
                        return currentCart.map(item =>
                            item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item
                        );
                    }
                    return [...currentCart, { ...product, quantity: 1 }];
                });
            };

            const handleUpdateCart = (product, newQuantity) => {
                if (newQuantity <= 0) {
                    setCart(currentCart => currentCart.filter(item => item.id !== product.id));
                } else {
                    setCart(currentCart => currentCart.map(item =>
                        item.id === product.id ? { ...item, quantity: newQuantity } : item
                    ));
                }
            };
            
            const handlePaymentSuccess = async () => {
                const saleDto = {
                    cartItems: cart.map(item => ({
                        id: item.id,
                        quantity: item.quantity,
                        price: item.price
                    }))
                };

                try {
                    const response = await fetch(`${API_URL}/sales`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(saleDto)
                    });
                    if (!response.ok) throw new Error('Falha ao registrar a venda.');
                } catch (err) {
                    console.error("Erro ao registrar venda:", err.message);
                    // Não trava o cliente, apenas loga o erro.
                } finally {
                    setView('thankyou');
                }
            };

            const resetPurchase = () => {
                setCart([]);
                setView('welcome');
            }

            let currentScreen;
            if (error) {
                 currentScreen = <div className="alert alert-danger m-5"><strong>Erro:</strong> {error}</div>;
            } else {
                switch (view) {
                    case 'shop':
                        currentScreen = <ShopScreen products={products} onAddToCart={handleAddToCart} cart={cart} onUpdateCart={handleUpdateCart} onCheckout={() => setView('payment')} />;
                        break;
                    case 'payment':
                        currentScreen = <PaymentScreen cart={cart} onPaymentSuccess={handlePaymentSuccess} />;
                        break;
                    case 'thankyou':
                        currentScreen = <ThankYouScreen onNewPurchase={resetPurchase} />;
                        break;
                    default:
                        currentScreen = <WelcomeScreen onStart={() => setView('shop')} />;
                }
            }

            return (
                <div className="main-container">
                    {currentScreen}
                </div>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
