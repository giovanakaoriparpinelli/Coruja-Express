<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Coruja Express</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8f9fa; }
        .navbar-brand { font-weight: 700; }
        .logo-highlight { color: #ffab00; }
        .modal-header { background-color: #4a148c; color: white; }
        .btn-primary { background-color: #4a148c; border-color: #4a148c; }
        .btn-primary:hover { background-color: #5e1a9e; border-color: #5e1a9e; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;

        // IMPORTANTE: Altere para a URL da sua API .NET em execução
        const API_URL = "http://localhost:5050/api"; 

        // --- Componente de Gerenciamento de Produtos ---
        const ProductManager = () => {
            const [products, setProducts] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const [showModal, setShowModal] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);

            const fetchProducts = useCallback(async () => {
                setIsLoading(true);
                try {
                    const response = await fetch(`${API_URL}/products/all`);
                    if (!response.ok) throw new Error('Falha ao buscar produtos.');
                    const data = await response.json();
                    setProducts(data);
                } catch (err) {
                    setError(err.message);
                } finally {
                    setIsLoading(false);
                }
            }, []);

            useEffect(() => {
                fetchProducts();
            }, [fetchProducts]);

            const handleSaveProduct = async (product) => {
                const isEditing = !!product.id;
                const url = isEditing ? `${API_URL}/products/${product.id}` : `${API_URL}/products`;
                const method = isEditing ? 'PUT' : 'POST';

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(product)
                    });
                    if (!response.ok) throw new Error('Falha ao salvar produto.');
                    
                    setShowModal(false);
                    setEditingProduct(null);
                    fetchProducts(); // Recarrega a lista
                } catch (err) {
                    alert(err.message);
                }
            };

            const handleEdit = (product) => {
                setEditingProduct(product);
                setShowModal(true);
            };

            const handleAddNew = () => {
                setEditingProduct({ name: '', price: 0, category: '', image: '', stock: 0 });
                setShowModal(true);
            };

            if (isLoading) return <div className="spinner-border" role="status"><span className="visually-hidden">Loading...</span></div>;
            if (error) return <p className="text-danger">Erro: {error}</p>;

            return (
                <div>
                    <button className="btn btn-primary mb-3" onClick={handleAddNew}>Adicionar Novo Produto</button>
                    <div className="table-responsive">
                        <table className="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nome</th>
                                    <th>Preço</th>
                                    <th>Categoria</th>
                                    <th>Estoque</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {products.map(p => (
                                    <tr key={p.id}>
                                        <td>{p.id}</td>
                                        <td>{p.name}</td>
                                        <td>R$ {p.price.toFixed(2)}</td>
                                        <td>{p.category}</td>
                                        <td>{p.stock}</td>
                                        <td>
                                            <button className="btn btn-sm btn-secondary" onClick={() => handleEdit(p)}>Editar</button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    {showModal && 
                        <ProductModal 
                            product={editingProduct} 
                            onClose={() => setShowModal(false)} 
                            onSave={handleSaveProduct}
                        />}
                </div>
            );
        };

        // --- Componente do Modal de Edição/Criação de Produto ---
        const ProductModal = ({ product, onClose, onSave }) => {
            const [formData, setFormData] = useState(product);

            const handleChange = (e) => {
                const { name, value, type } = e.target;
                setFormData(prev => ({
                    ...prev,
                    [name]: type === 'number' ? parseFloat(value) || 0 : value
                }));
            };

            const handleSubmit = (e) => {
                e.preventDefault();
                onSave(formData);
            };

            return (
                <div className="modal" style={{ display: 'block', backgroundColor: 'rgba(0,0,0,0.5)' }}>
                    <div className="modal-dialog modal-dialog-centered">
                        <div className="modal-content">
                            <form onSubmit={handleSubmit}>
                                <div className="modal-header">
                                    <h5 className="modal-title">{product.id ? 'Editar Produto' : 'Novo Produto'}</h5>
                                    <button type="button" className="btn-close btn-close-white" onClick={onClose}></button>
                                </div>
                                <div className="modal-body">
                                    <div className="mb-3">
                                        <label className="form-label">Nome</label>
                                        <input type="text" className="form-control" name="name" value={formData.name} onChange={handleChange} required />
                                    </div>
                                    <div className="row">
                                        <div className="col-md-6 mb-3">
                                            <label className="form-label">Preço (R$)</label>
                                            <input type="number" step="0.01" className="form-control" name="price" value={formData.price} onChange={handleChange} required />
                                        </div>
                                        <div className="col-md-6 mb-3">
                                            <label className="form-label">Estoque</label>
                                            <input type="number" className="form-control" name="stock" value={formData.stock} onChange={handleChange} required />
                                        </div>
                                    </div>
                                    <div className="mb-3">
                                        <label className="form-label">Categoria</label>
                                        <input type="text" className="form-control" name="category" value={formData.category} onChange={handleChange} />
                                    </div>
                                    <div className="mb-3">
                                        <label className="form-label">URL da Imagem</label>
                                        <input type="text" className="form-control" name="image" value={formData.image} onChange={handleChange} />
                                    </div>
                                </div>
                                <div className="modal-footer">
                                    <button type="button" className="btn btn-light" onClick={onClose}>Cancelar</button>
                                    <button type="submit" className="btn btn-primary">Salvar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Componente de Histórico de Vendas ---
        const SalesHistory = () => {
            const [sales, setSales] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                const fetchSales = async () => {
                    setIsLoading(true);
                    try {
                        const response = await fetch(`${API_URL}/sales`);
                        if (!response.ok) throw new Error('Falha ao buscar vendas.');
                        const data = await response.json();
                        setSales(data);
                    } catch (err) {
                        setError(err.message);
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchSales();
            }, []);

            if (isLoading) return <div className="spinner-border" role="status"><span className="visually-hidden">Loading...</span></div>;
            if (error) return <p className="text-danger">Erro: {error}</p>;

            return (
                <div className="accordion">
                    {sales.length === 0 && <p>Nenhuma venda registrada ainda.</p>}
                    {sales.map(sale => (
                        <div className="accordion-item" key={sale.id}>
                            <h2 className="accordion-header">
                                <button className="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target={`#sale-${sale.id}`}>
                                    Venda #{sale.id} - {new Date(sale.saleDate).toLocaleString('pt-BR')} - Total: R$ {sale.totalAmount.toFixed(2)}
                                </button>
                            </h2>
                            <div id={`sale-${sale.id}`} className="accordion-collapse collapse">
                                <div className="accordion-body">
                                    <ul className="list-group">
                                        {sale.saleItems.map(item => (
                                            <li key={item.id} className="list-group-item d-flex justify-content-between">
                                                <span>{item.product?.name || 'Produto não encontrado'} ({item.quantity}x)</span>
                                                <span>R$ {item.unitPrice.toFixed(2)}</span>
                                            </li>
                                        ))}
                                    </ul>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        // --- Componente Principal da Aplicação Admin ---
        const App = () => {
            const [view, setView] = useState('products'); // 'products' ou 'sales'

            return (
                <>
                    <nav className="navbar navbar-expand-lg navbar-dark bg-dark">
                        <div className="container">
                            <a className="navbar-brand" href="#">Admin Coruja<span className="logo-highlight">Express</span>🦉</a>
                        </div>
                    </nav>

                    <div className="container mt-4">
                        <ul className="nav nav-tabs mb-3">
                            <li className="nav-item">
                                <a className={`nav-link ${view === 'products' ? 'active' : ''}`} href="#" onClick={() => setView('products')}>Gerenciar Produtos</a>
                            </li>
                            <li className="nav-item">
                                <a className={`nav-link ${view === 'sales' ? 'active' : ''}`} href="#" onClick={() => setView('sales')}>Histórico de Vendas</a>
                            </li>
                        </ul>
                        
                        {view === 'products' ? <ProductManager /> : <SalesHistory />}
                    </div>
                </>
            );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
